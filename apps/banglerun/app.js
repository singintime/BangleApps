!function(){"use strict";class t{getDistance(t){const s=6371008.8*Math.sin(t.lat)*Math.cos(t.lon),i=6371008.8*Math.sin(t.lat)*Math.sin(t.lon),r=6371008.8*Math.cos(t.lat),e=t.vel,a=Date.now();if(0===this._t)return this._x=s,this._y=i,this._z=r,this._v=e,this._t=a,this._ep=50,void(this._ev=1);const h=s-this._x,n=i-this._y,o=r-this._z,d=e-this._v,w=a-this._t,l=Math.sqrt(h*h+n*n+o*o),g=Math.sqrt(d*d);this._ep+=this._v*w;const _=this._ep/(this._ep+l+2.5*t.dop),c=this._ev/(this._ev+g+.05*t.dop);return this._x+=(h-this._x)*_,this._y+=(n-this._y)*_,this._z+=(o-this._z)*_,this._v+=(d-this._v)*c,this._t=a,{t:w,d:l*_}}}class s{constructor(t){this._callbackFn=t,this._lat=NaN,this._lon=NaN,this._vel=NaN,this._dop=NaN}parse(t){const s=t.split(",");switch(s[0].substr(3,3)){case"GGA":this._lat=this._parseCoord(s[2],s[3]),this._lon=this._parseCoord(s[4],s[5]),this._dop=parseFloat(s[8]);break;case"VTG":this._vel=parseFloat(s[7])/3.6;break;case"GLL":this._isValid()&&this._callbackFn({lat:this._lat,lon:this._lon,vel:this._vel,dop:this._dop})}}_isValid(){return!isNaN(this._lat)&&!isNaN(this._lon)&&!isNaN(this._vel)&&this._dop<5}_parseCoord(t,s){const i=t.indexOf(".")-2,r=(parseInt(t.substr(0,i))+parseFloat(t.substr(i))/60)*Math.PI/180;return"S"===s||"W"===s?-r:r}}const i=E.toArrayBuffer(atob("EBABwADwAPwA/wD/wP/w//z///////z/8P/A/wD8APAAwAA=")),r=E.toArrayBuffer(atob("EBAB/D/8P/w//D/8P/w//D/8P/w//D/8P/w//D/8P/w//D8=")),e=E.toArrayBuffer(atob("EBAB//////////////////////////////////////////8=")),a=E.toArrayBuffer(atob("EBABAAAAAAAAAAEDww/3P/9///w/8H/A/4H/A/8AAAAAAAA=")),h=Graphics.createArrayBuffer(240,240,16);(new class{constructor(){this.nmeaParser=new s(t=>this.handleGps(t)),this.gpsHandler=new t,this.totDist=0,this.totTime=0,this.totSteps=0,this.gpsReady=!1,this.running=!1,this.drawing=!0,this.views=[()=>this.drawFirst(),()=>this.drawSecond(),()=>this.drawThird()],this.viewIndex=0}formatClock(t){return("0"+t.getHours()).substr(-2)+":"+("0"+t.getMinutes()).substr(-2)}formatDistance(t){return(t/1e3).toFixed(2)}formatTime(t){const s=Math.round(t),i=Math.floor(s/3600),r=s%60;return(i?i+":":"")+("0"+Math.floor(s/60)%60).substr(-2)+":"+("0"+r).substr(-2)}formatPace(t){if(t<=.6)return"__'__\"";const s=Math.round(3600/t),i=s%60;return("0"+Math.floor(s/60)).substr(-2)+"'"+("0"+i).substr(-2)+'"'}drawHeader(){h.setFont("6x8",2),h.setFontAlign(-1,-1,0),h.setColor(this.gpsReady?2016:63488),h.drawString("GPS",10,20),h.setFontAlign(0,-1,0),h.setColor(65535),h.drawString(this.formatClock(new Date),120,20)}drawFooter(t){for(let s=0;s<this.views.length;s++){const i=240/this.views.length;h.setColor(s===t?1055:16904),h.fillRect(i*s+5,224,i*(s+1)-5,240)}}drawButtons(){h.setColor(65535),h.drawImage(this.running?r:i,214,32),h.drawImage(this.running?r:e,214,192),h.drawImage(a,214,112)}drawFirst(){h.setFont("6x8",2),h.setFontAlign(0,-1,0),h.setColor(65535),h.drawString("DISTANCE (KM)",120,50),h.drawString("TIME",120,140),h.setFontVector(40),h.drawString(this.formatDistance(this.totDist),120,70),h.drawString(this.formatTime(this.totTime),120,160)}drawSecond(){const t=this.totTime?3.6*this.totDist/this.totTime:0,s=this.totTime?Math.round(60*this.totSteps/this.totTime):0;h.setColor(65535),h.setFontAlign(0,-1,0),h.setFont("6x8",2),h.drawString("PACE (/KM)",120,50),h.drawString("CADENCE",120,140),h.setFontVector(40),h.drawString(this.formatPace(t),120,70),h.drawString(Math.round(s),120,160)}drawThird(){h.setColor(65535),h.setFontAlign(0,-1,0),h.setFont("6x8",2),h.drawString("STEPS",120,50),h.setFontVector(40),h.drawString(this.totSteps,120,70)}draw(){this.drawing&&(h.clear(),this.drawHeader(),this.drawButtons(),this.drawFooter(this.viewIndex),this.views[this.viewIndex](),g.drawImage(h.asImage,0,0))}scroll(){this.drawing&&(this.viewIndex=(this.viewIndex+this.views.length+1)%this.views.length,this.draw())}handleGps(t){const s=this.gpsHandler.getDistance(t);this.gpsReady=!0,this.running&&(this.totDist+=s.d,this.totTime+=s.t),this.draw()}handleStep(){this.running&&(this.totSteps+=1)}start(){this.running=!this.running,this.draw()}stop(){this.running||(this.totDist=0,this.totTime=0,this.totSteps=0),this.running=!1,Bangle.setHRMPower(0),this.draw()}run(){Bangle.on("GPS-raw",t=>{this.gpsReady=!1,this.nmeaParser.parse(t)}),Bangle.on("step",()=>this.handleStep()),Bangle.on("lcdPower",t=>{this.drawing=t,t&&this.draw()}),Bangle.setGPSPower(1),this.draw(),setWatch(()=>this.start(),BTN1,{repeat:!0,edge:"rising"}),setWatch(()=>this.scroll(),BTN2,{repeat:!0,edge:"rising"}),setWatch(()=>this.stop(),BTN3,{repeat:!0,edge:"rising"})}}).run()}();
